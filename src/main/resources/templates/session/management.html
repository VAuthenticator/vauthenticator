<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
    <meta charset="UTF-8">
    <title>OP Session Management Checker IFrame</title>
</head>
<body>

<script th:inline="javascript">
    /*<![CDATA[*/
    window.addEventListener("message", receiveMessage, false);

    function receiveMessage(e) { // e.data has client_id and session_state

        var client_id = e.data.split(' ')[0];
        var session_state = e.data.split(' ')[1];
        var salt = session_state.split('.')[1];
        var issuer = [[${issuer}]]

        // if message is syntactically invalid
        //     postMessage('error', e.origin) and return

        // if message comes an unexpected origin
        //     postMessage('error', e.origin) and return

        // get_op_user_agent_state() is an OP defined function
        // that returns the User Agent's login status at the OP.
        // How it is done is entirely up to the OP.
        var opuas = get_op_user_agent_state();
        // Here, the session_state is calculated in this particular way,
        // but it is entirely up to the OP how to do it under the
        // requirements defined in this specification.
        var ss = CryptoJS.SHA256(client_id + ' ' + issuer + ' ' +
            opuas + ' ' + salt) + "." + salt;

        var stat = '';
        if (String(session_state) === String(ss)) {
            stat = 'unchanged';
        } else {
            stat = 'changed';
        }

        e.source.postMessage(stat, e.origin);
    };

    function get_op_user_agent_state() {
        return document.cookie.split("=")[1] || ""
    }
    /*]]>*/

</script>

</body>
</html>